<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Timber Sale Areas Viewer</title>

    <!-- Leaflet CSS and JS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>

    <!-- DataTables CSS and JS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/datatables/1.10.21/css/dataTables.bootstrap4.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/datatables/1.10.21/js/jquery.dataTables.min.js"></script>

    <!-- Bootstrap CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.6.0/css/bootstrap.min.css" rel="stylesheet" />

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f8f9fa; }
        .header { background: linear-gradient(135deg, #2d5016 0%, #4a7c24 100%); color: white; padding: 2rem 0; margin-bottom: 2rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .header h1 { margin: 0; font-weight: 300; }
        .header p { margin: 0.5rem 0 0 0; opacity: 0.9; }
        .main-container { max-width: 1400px; margin: 0 auto; padding: 0 1rem; }
        .map-container { height: 600px; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 2rem; }
        #map { height: 100%; width: 100%; }
        .controls-panel { background: white; border-radius: 8px; padding: 1.5rem; margin-bottom: 2rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .data-table-container { background: white; border-radius: 8px; padding: 1.5rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 2rem; }
        .btn-forest { background-color: #4a7c24; border-color: #4a7c24; color: white; }
        .btn-forest:hover { background-color: #2d5016; border-color: #2d5016; color: white; }
        .stats-card { background: white; border-radius: 8px; padding: 1.5rem; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 1rem; }
        .stats-number { font-size: 2rem; font-weight: bold; color: #4a7c24; }
        .stats-label { color: #6c757d; font-size: 0.9rem; }
        .leaflet-popup-content { max-width: 300px; }
        .popup-title { font-weight: bold; color: #4a7c24; margin-bottom: 0.5rem; }
        .popup-field { margin-bottom: 0.3rem; font-size: 0.9rem; }
        .popup-label { font-weight: 600; color: #495057; }
        #saleAreasTable { font-size: 0.9rem; }
        #saleAreasTable th { background-color: #f8f9fa; font-weight: 600; border-bottom: 2px solid #dee2e6; }
        #saleAreasTable tbody tr:hover { background-color: #f1f8e9; cursor: pointer; }
        .small-note { font-size: 0.9rem; color: #6c757d; }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1>üå≤ Timber Sale Areas Management</h1>
            <p>Interactive map and data table for timber stand management (vetted datasets only)</p>
        </div>
    </div>

    <div class="main-container">
        <!-- Statistics Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-number" id="totalAreas">0</div>
                    <div class="stats-label">Total Sale Areas</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-number" id="totalAcres">0</div>
                    <div class="stats-label">Total Acres</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-number" id="avgSize">0</div>
                    <div class="stats-label">Avg Size (acres)</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-number" id="activeAreas">0</div>
                    <div class="stats-label">Active Areas</div>
                </div>
            </div>
        </div>

        <!-- Submission & Approved Data Controls -->
        <div class="controls-panel">
            <h4>üõ°Ô∏è Submit & Load Data</h4>
            <p class="mb-3 small-note">
                Public uploads go to a private staging folder first. After validation in QGIS, approved datasets appear in the list below.
            </p>

            <!-- Replace direct upload with a submission link/form you control -->
            <div class="mb-3">
                <a id="submitLink" 
                   href="https://forms.gle/a9LQ3uDWgfTZjDQg9" 
                   target="_blank" 
                   class="btn btn-forest mr-2">
                   Submit Dataset
                </a>
                <button id="refreshBtn" class="btn btn-outline-secondary">Refresh Approved List</button>
            </div>

            <!-- List of approved datasets pulled from data/approved/manifest.json -->
            <div class="form-row align-items-end">
                <div class="form-group col-md-6">
                    <label for="datasetSelect">Approved datasets</label>
                    <select id="datasetSelect" class="form-control">
                        <option value="" disabled selected>‚Äî none loaded ‚Äî</option>
                    </select>
                </div>
                <div class="form-group col-md-6">
                    <button id="addDatasetBtn" class="btn btn-forest">Add Selected to Map</button>
                    <button id="loadAllBtn" class="btn btn-outline-secondary ml-2">Load All Approved</button>
                    <button id="clearBtn" class="btn btn-outline-danger ml-2">Clear Map/Data</button>
                </div>
            </div>
        </div>

        <!-- Map Container -->
        <div class="map-container">
            <div id="map"></div>
        </div>

        <!-- Data Table -->
        <div class="data-table-container">
            <h4>üìã Sale Areas Data Table</h4>
            <div class="table-responsive">
                <table id="saleAreasTable" class="table table-striped table-bordered">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Acres</th>
                            <th>Species</th>
                            <th>Status</th>
                            <th>Sale Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // ====== MAP SETUP ======
        let map = L.map('map').setView([44.5, -89.5], 8);
        let currentLayers = []; // array of L.geoJSON layers (one per dataset)
        let currentData = [];   // flat array of all features loaded

        // Base layers
        const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap contributors', maxZoom: 18 }).addTo(map);
        const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Esri, Maxar, USDA FSA, USGS' });
        L.control.layers({ 'Street Map': osm, 'Satellite': satellite }).addTo(map);

        // DataTable setup
        let dataTable = $('#saleAreasTable').DataTable({
            responsive: true,
            pageLength: 10,
            order: [[0, 'asc']],
            columnDefs: [
                { targets: [2], render: function(data) { const n = parseFloat(data); return isNaN(n) ? data : n.toLocaleString() + ' ac'; }},
                { targets: [6], orderable: false }
            ]
        });

        // ====== APPROVED DATA MANIFEST ======
        const MANIFEST_URL = 'data/approved/manifest.json'; // generated/maintained in repo
        const SUBMIT_URL = 'https://forms.gle/a9LQ3uDWgfTZjDQg9'; // change in Step 2
        document.getElementById('submitLink').href = SUBMIT_URL;

        async function fetchManifest() {
            try {
                const res = await fetch(MANIFEST_URL, { cache: 'no-store' });
                if (!res.ok) throw new Error('No manifest yet');
                const manifest = await res.json();
                return Array.isArray(manifest.datasets) ? manifest.datasets : [];
            } catch (e) {
                console.warn('Manifest fetch failed:', e);
                return [];
            }
        }

        function filenameToName(path) {
            const file = path.split('/').pop().replace(/\.geojson$/i, '');
            return file.replace(/[_-]+/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
        }

        async function refreshApprovedList() {
            const select = document.getElementById('datasetSelect');
            select.innerHTML = '';

            const datasets = await fetchManifest();
            if (datasets.length === 0) {
                const opt = document.createElement('option');
                opt.textContent = 'No approved datasets yet';
                opt.disabled = true; opt.selected = true;
                select.appendChild(opt);
                return;
            }

            const placeholder = document.createElement('option');
            placeholder.textContent = '‚Äî select a dataset ‚Äî';
            placeholder.disabled = true; placeholder.selected = true;
            select.appendChild(placeholder);

            datasets.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p; opt.textContent = filenameToName(p);
                select.appendChild(opt);
            });
        }

        // ====== LOADING APPROVED DATASETS ======
        function getStatusColor(status) {
            const colors = { 'active': '#4a7c24', 'planned': '#ffc107', 'harvested': '#6c757d', 'sold': '#28a745', 'pending': '#fd7e14' };
            return colors[(status || '').toString().toLowerCase()] || '#4a7c24';
        }
        function formatLabel(key) { return key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()); }

        async function addApprovedToMap(path) {
            try {
                const res = await fetch(path, { cache: 'no-store' });
                if (!res.ok) throw new Error('Could not fetch ' + path);
                const geojsonData = await res.json();

                const layer = L.geoJSON(geojsonData, {
                    style: f => ({ fillColor: getStatusColor(f.properties?.status || 'active'), weight: 2, opacity: 1, color: '#2d5016', dashArray: '3', fillOpacity: 0.6 }),
                    onEachFeature: function(feature, lyr) {
                        let popupContent = '<div class="popup-title">Sale Area Details</div>';
                        const props = feature.properties || {};
                        Object.keys(props).forEach(key => {
                            if (props[key] !== null && props[key] !== '') {
                                popupContent += `<div class="popup-field"><span class="popup-label">${formatLabel(key)}:</span> ${props[key]}</div>`;
                            }
                        });
                        lyr.bindPopup(popupContent);
                        lyr.on('click', () => map.fitBounds(lyr.getBounds()));
                    }
                }).addTo(map);

                currentLayers.push(layer);
                currentData.push(...(geojsonData.features || []));

                // Fit to bounds of all layers
                const group = L.featureGroup(currentLayers);
                if (group.getLayers().length) map.fitBounds(group.getBounds());

                // Update table & stats
                populateDataTable(currentData);
                updateStatistics(currentData);
            } catch (err) {
                console.error(err);
                alert('Failed to load approved dataset: ' + path);
            }
        }

        async function addSelectedDataset() {
            const path = document.getElementById('datasetSelect').value;
            if (!path) return alert('Pick a dataset first.');
            await addApprovedToMap(path);
        }

        async function loadAllApproved() {
            const datasets = await fetchManifest();
            if (!datasets.length) return alert('No approved datasets found.');
            for (const p of datasets) { await addApprovedToMap(p); }
        }

        function clearData() {
            currentLayers.forEach(l => map.removeLayer(l));
            currentLayers = []; currentData = [];
            dataTable.clear().draw();
            document.getElementById('totalAreas').textContent = '0';
            document.getElementById('totalAcres').textContent = '0';
            document.getElementById('avgSize').textContent = '0';
            document.getElementById('activeAreas').textContent = '0';
        }

        // ====== TABLE + STATS ======
        function populateDataTable(features) {
            dataTable.clear();
            features.forEach((feature, index) => {
                const props = feature.properties || {};
                const row = [
                    props.id || props.fid || index + 1,
                    props.name || props.sale_name || 'Unnamed',
                    props.acres || props.area || '‚Äî',
                    props.species || props.dominant_species || 'Mixed',
                    props.status || 'Active',
                    props.sale_date || props.harvest_date || 'TBD',
                    `<button class="btn btn-sm btn-forest" onclick="zoomToFeature(${index})">View</button>` +
                    `<button class="btn btn-sm btn-outline-secondary ml-1" onclick="showDetails(${index})">Details</button>`
                ];
                dataTable.row.add(row);
            });
            dataTable.draw();
        }

        function updateStatistics(features) {
            const totalAreas = features.length;
            let totalAcres = 0; let activeAreas = 0;
            features.forEach(f => {
                const a = parseFloat(f.properties?.acres || f.properties?.area || 0);
                if (!isNaN(a)) totalAcres += a;
                const status = (f.properties?.status || 'active').toString().toLowerCase();
                if (status === 'active') activeAreas++;
            });
            const avgSize = totalAreas > 0 ? (totalAcres / totalAreas) : 0;
            document.getElementById('totalAreas').textContent = totalAreas.toLocaleString();
            document.getElementById('totalAcres').textContent = Math.round(totalAcres).toLocaleString();
            document.getElementById('avgSize').textContent = Math.round(avgSize).toLocaleString();
            document.getElementById('activeAreas').textContent = activeAreas.toLocaleString();
        }

        function zoomToFeature(index) {
            const feature = currentData[index];
            if (!feature) return;
            currentLayers.forEach(layer => {
                layer.eachLayer(lyr => {
                    if (lyr.feature === feature) {
                        map.fitBounds(lyr.getBounds());
                        lyr.openPopup();
                    }
                });
            });
        }

        function showDetails(index) {
            const feature = currentData[index];
            if (!feature) return;
            let details = 'Detailed Information:\n\n';
            Object.keys(feature.properties || {}).forEach(key => {
                details += `${formatLabel(key)}: ${feature.properties[key]}\n`;
            });
            alert(details);
        }

        // ====== UI HOOKS ======
        document.getElementById('refreshBtn').addEventListener('click', refreshApprovedList);
        document.getElementById('addDatasetBtn').addEventListener('click', addSelectedDataset);
        document.getElementById('loadAllBtn').addEventListener('click', loadAllApproved);
        document.getElementById('clearBtn').addEventListener('click', clearData);

        // Initial load
        refreshApprovedList();
    </script>
</body>
</html>
