<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timber Sale Areas Viewer</title>
    
    <!-- Leaflet CSS and JS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    
    <!-- DataTables CSS and JS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/datatables/1.10.21/css/dataTables.bootstrap4.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/datatables/1.10.21/js/jquery.dataTables.min.js"></script>
    
    <!-- Bootstrap CSS and JS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.6.0/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.6.0/js/bootstrap.min.js"></script>
    
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
        }
        
        .header {
            background: linear-gradient(135deg, #2d5016 0%, #4a7c24 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .company-banner {
            background: linear-gradient(135deg, #8B4513 0%, #A0522D 100%);
            color: white;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .company-banner:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            background: linear-gradient(135deg, #A0522D 0%, #8B4513 100%);
        }

        .bid-info-panel {
            background: #fff3cd;
            border: 2px solid #ffeaa7;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
        }

        .bid-deadline {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            padding: 1rem;
            border-radius: 6px;
            margin-top: 1rem;
            text-align: center;
        }

        /* Status toggle controls */
        .status-toggle-panel {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .status-toggle {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #4a7c24;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .status-legend {
            display: flex;
            gap: 2rem;
            margin-top: 1rem;
            font-size: 0.9rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 3px;
            border: 2px solid;
        }

        .legend-active {
            background-color: #28a745;
            border-color: #2d5016;
        }

        .legend-closed {
            background-color: #6c757d;
            border-color: #495057;
        }
        
        /* Custom popup styles for smaller, scrollable popups */
        .leaflet-popup {
            max-width: 350px !important;
            max-height: 300px !important;
        }
        
        .leaflet-popup-content-wrapper {
            max-height: 300px !important;
            overflow: hidden !important;
        }
        
        .leaflet-popup-content {
            max-height: 270px !important;
            overflow-y: auto !important;
            margin: 12px 16px !important;
            font-size: 13px !important;
            line-height: 1.4 !important;
        }
        
        .leaflet-popup-scrolled {
            padding-right: 8px;
        }
        
        /* Auto-update notification styles */
        .update-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            max-width: 400px;
        }
        
        .loading-indicator {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255,255,255,0.95);
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 10000;
        }
        
        .last-updated {
            background: #e8f5e8;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            font-size: 0.9rem;
            color: #2d5016;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* Rest of existing styles */
        .main-container { max-width: 1400px; margin: 0 auto; padding: 0 1rem; }
        .map-container { height: 600px; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 2rem; }
        #map { height: 100%; width: 100%; }
        .controls-panel { background: white; border-radius: 8px; padding: 1.5rem; margin-bottom: 2rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .data-table-container { background: white; border-radius: 8px; padding: 1.5rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 2rem; }
        .btn-forest { background-color: #4a7c24; border-color: #4a7c24; color: white; }
        .btn-forest:hover { background-color: #2d5016; border-color: #2d5016; color: white; }
        .stats-card { background: white; border-radius: 8px; padding: 1.5rem; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 1rem; }
        .stats-number { font-size: 2rem; font-weight: bold; color: #4a7c24; }
        .stats-label { color: #6c757d; font-size: 0.9rem; }
        
        .popup-title {
            font-weight: bold;
            margin-bottom: 0.5rem;
            color: #2d5016;
            font-size: 1.0rem;
            border-bottom: 1px solid #eee;
            padding-bottom: 0.3rem;
        }
        
        .popup-field {
            margin-bottom: 0.25rem;
            font-size: 0.85rem;
        }
        
        .popup-label {
            font-weight: bold;
            color: #4a7c24;
        }

        .popup-status {
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: bold;
            text-transform: uppercase;
        }

        .popup-status.active {
            background: #d4edda;
            color: #155724;
        }

        .popup-status.closed {
            background: #f8d7da;
            color: #721c24;
        }

        /* URL column styling */
        .url-cell {
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .pdf-link {
            background: white;
            color: #333;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            text-decoration: none;
            font-size: 0.8rem;
            display: inline-block;
            margin-top: 0.25rem;
            border: 1px solid #ccc;
        }

        .pdf-link:hover {
            background: #f8f9fa;
            color: #333;
            text-decoration: none;
            border-color: #999;
        }

        .layer-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            font-size: 0.85rem;
            min-width: 170px;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(0,0,0,0.1);
        }

        .layer-control-item {
            margin-bottom: 8px;
            display: flex;
            align-items: center;
        }

        .layer-control-item:last-child {
            margin-bottom: 0;
        }

        .layer-control-item input[type="checkbox"],
        .layer-control-item input[type="radio"] {
            margin-right: 8px;
        }

        .layer-control-title {
            font-weight: bold;
            margin-bottom: 8px;
            padding-bottom: 4px;
            border-bottom: 1px solid #ddd;
            color: #2d5016;
        }

        /* Status badge in table */
        .status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: bold;
            text-transform: uppercase;
        }

        .status-badge.active {
            background: #d4edda;
            color: #155724;
        }

        .status-badge.closed {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1>🌲 Timber Sale Areas Management</h1>
            <p>Interactive map and data table for timber stand management</p>
        </div>
    </div>
    
    <div class="main-container">
        <!-- Company Banner -->
        <div class="company-banner" onclick="window.open('https://legacyforestmanagement.com/timber-for-sale/', '_blank')">
            <h3>🌳 Legacy Forest Management - Timber For Sale 🌳</h3>
            <p>Click here to visit our timber sales website</p>
        </div>

        <!-- Bid Information Panel -->
        <div class="bid-info-panel">
            <h4><strong>Timber For Sale</strong></h4>
            <p><strong><em>Bidding Open for the following sales: (updated: September 25, 2025)</em></strong></p>
            <div class="bid-deadline">
                <h5><strong>Bids Due OCTOBER 15, 2025 @ 12PM</strong></h5>
                <p><strong>Submit Bids to: bids@legacyforestmanagement.com<br>
                101 1/2 N Water St. Sparta, WI 54656</strong></p>
            </div>
        </div>
        
        <!-- Loading Indicator -->
        <div id="loadingIndicator" class="loading-indicator" style="display: none;">
            <div class="text-center">
                <div class="spinner-border text-success" role="status">
                    <span class="sr-only">Loading...</span>
                </div>
                <div class="mt-2">Loading timber sale data...</div>
            </div>
        </div>
        
        <!-- Last Updated Info -->
        <div id="lastUpdated" class="last-updated">
            <span>📅 Data last updated: <span id="updateTime"></span></span>
        </div>

        <!-- Status Toggle Panel -->
        <div class="status-toggle-panel">
            <h5>📊 Sales Display Options</h5>
            <div class="status-toggle">
                <span><strong>Show Active Sales Only</strong></span>
                <label class="toggle-switch">
                    <input type="checkbox" id="showClosedSales">
                    <span class="slider"></span>
                </label>
                <span><strong>Include Closed Sales</strong></span>
            </div>
            <div class="status-legend">
                <div class="legend-item">
                    <div class="legend-color legend-active"></div>
                    <span>Active Sales (Open for Bidding)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color legend-closed"></div>
                    <span>Closed Sales (Bidding Ended)</span>
                </div>
            </div>
        </div>
        
        <!-- Statistics Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-number" id="totalAreas">7</div>
                    <div class="stats-label">Total Sale Areas</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-number" id="totalAcres">393.5</div>
                    <div class="stats-label">Total Acres</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-number" id="avgSize">56</div>
                    <div class="stats-label">Avg Size (acres)</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-number" id="activeAreas">7</div>
                    <div class="stats-label">Active Areas</div>
                </div>
            </div>
        </div>
        
        <!-- Map Container -->
        <div class="map-container" style="position: relative;">
            <div id="map"></div>
            <!-- Layer Controls Panel -->
            <div class="layer-controls">
                <div class="layer-control-title">🗺️ Map Controls</div>
                
                <div style="margin-bottom: 12px;">
                    <strong>Base Layers:</strong>
                </div>
                <div class="layer-control-item">
                    <input type="radio" id="osm" name="baseLayer" value="osm" checked>
                    <label for="osm">Street Map</label>
                </div>
                <div class="layer-control-item">
                    <input type="radio" id="satellite" name="baseLayer" value="satellite">
                    <label for="satellite">Satellite</label>
                </div>
                <div class="layer-control-item">
                    <input type="radio" id="topo" name="baseLayer" value="topo">
                    <label for="topo">Topography</label>
                </div>
                
                <div style="margin: 12px 0 8px 0; border-top: 1px solid #ddd; padding-top: 8px;">
                    <strong>Data Layers:</strong>
                </div>
                <div class="layer-control-item">
                    <input type="checkbox" id="timberAreas" checked>
                    <label for="timberAreas">Timber Sale Areas</label>
                </div>
            </div>
        </div>
        
        <!-- Data Table -->
        <div class="data-table-container">
            <h4>📋 Sale Areas Data Table</h4>
            <div class="table-responsive">
                <table id="saleAreasTable" class="table table-striped table-bordered">
                    <thead class="thead-light">
                        <tr>
                            <th>Sale ID</th>
                            <th>Property Name</th>
                            <th>Status</th>
                            <th>Acres</th>
                            <th>Volume</th>
                            <th>Species</th>
                            <th>Location</th>
                            <th>Bid Due</th>
                            <th>Prospectus</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Initialize map and global variables
        let map = L.map('map').setView([44.0, -90.5], 8);
        let saleAreasLayer = null;
        let currentData = [];
        let filteredData = [];
        let lastUpdateTime = null;
        let showClosedSales = false;
        
        // Base map layers
        let baseLayers = {
            'Street Map': L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors',
                maxZoom: 18
            }),
            'Satellite': L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: '© Esri, Maxar, GeoEye, Earthstar Geographics, CNES/Airbus DS, USDA, USGS, AeroGRID, IGN, and the GIS User Community',
                maxZoom: 18
            }),
            'Topography': L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}', {
                attribution: '© Esri, HERE, Garmin, Intermap, increment P Corp., GEBCO, USGS, FAO, NPS, NRCAN, GeoBase, IGN, Kadaster NL, Ordnance Survey, Esri Japan, METI, Esri China (Hong Kong), (c) OpenStreetMap contributors, and the GIS User Community',
                maxZoom: 18
            })
        };
        
        // Add default base layer
        baseLayers['Street Map'].addTo(map);
        
        // Initialize DataTable
        let dataTable = $('#saleAreasTable').DataTable({
            responsive: true,
            pageLength: 10,
            order: [[0, 'asc']],
            columnDefs: [
                {
                    targets: [2], // Status column
                    render: function(data, type, row) {
                        if (type === 'display') {
                            const statusClass = data.toLowerCase() === 'active' ? 'active' : 'closed';
                            const statusText = data.toLowerCase() === 'active' ? 'Active' : 'Sale Closed';
                            return `<span class="status-badge ${statusClass}">${statusText}</span>`;
                        }
                        return data;
                    }
                },
                { 
                    targets: [3], // Acres column
                    render: function(data) { 
                        return parseFloat(data || 0).toLocaleString() + ' ac'; 
                    }
                },
                {
                    targets: [8], // Prospectus column
                    render: function(data, type, row) {
                        if (!data || data === 'N/A') {
                            return '<span class="text-muted">None</span>';
                        }
                        if (type === 'display') {
                            return `<a href="${data}" target="_blank" class="pdf-link">📄 View PDF</a>`;
                        }
                        return data;
                    }
                },
                { targets: [9], orderable: false } // Actions column
            ]
        });
        
        // Data will be loaded from external GeoJSON file
        let timberSaleData = null;
        
        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            loadDataFromFile();
            setupLayerControls();
            setupStatusToggle();
        });

        function setupStatusToggle() {
            const toggleCheckbox = document.getElementById('showClosedSales');
            toggleCheckbox.addEventListener('change', function() {
                showClosedSales = this.checked;
                updateDisplayedData();
            });
        }

        function updateDisplayedData() {
            if (!timberSaleData) return;

            // Filter data based on toggle setting
            if (showClosedSales) {
                filteredData = timberSaleData.features; // Show all
            } else {
                filteredData = timberSaleData.features.filter(feature => {
                    const status = (feature.properties.status || 'active').toLowerCase();
                    return status === 'active';
                });
            }

            // Update map
            updateMapDisplay();
            
            // Update table
            populateDataTable(filteredData);
            
            // Update statistics
            updateStatistics(filteredData);
        }

        function updateMapDisplay() {
            // Clear existing layer
            if (saleAreasLayer) {
                map.removeLayer(saleAreasLayer);
            }

            // Create filtered GeoJSON
            const filteredGeoJSON = {
                type: "FeatureCollection",
                features: filteredData
            };

            // Add filtered data to map
            saleAreasLayer = L.geoJSON(filteredGeoJSON, {
                style: function(feature) {
                    const status = (feature.properties.status || 'active').toLowerCase();
                    const isActive = status === 'active';
                    
                    return {
                        fillColor: isActive ? '#28a745' : '#6c757d',
                        weight: 2,
                        opacity: 1,
                        color: isActive ? '#2d5016' : '#495057',
                        dashArray: isActive ? '3' : '8, 5',
                        fillOpacity: isActive ? 0.6 : 0.4
                    };
                },
                onEachFeature: function(feature, layer) {
                    const popupContent = createPopupContent(feature.properties);
                    layer.bindPopup(popupContent, {
                        maxWidth: 350,
                        maxHeight: 300,
                        closeButton: true,
                        autoPan: true,
                        keepInView: true
                    });
                    
                    layer.on('click', function() {
                        map.fitBounds(layer.getBounds());
                    });
                }
            });

            // Add to map if timber areas checkbox is checked
            if (document.getElementById('timberAreas').checked) {
                saleAreasLayer.addTo(map);
            }

            // Fit map to data bounds if there's data
            if (filteredData.length > 0) {
                map.fitBounds(saleAreasLayer.getBounds());
            }
        }
        
        function setupLayerControls() {
            // Base layer radio buttons
            document.querySelectorAll('input[name="baseLayer"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    // Remove current base layer
                    Object.values(baseLayers).forEach(layer => {
                        if (map.hasLayer(layer)) {
                            map.removeLayer(layer);
                        }
                    });
                    
                    // Add selected base layer
                    switch(this.value) {
                        case 'osm':
                            baseLayers['Street Map'].addTo(map);
                            break;
                        case 'satellite':
                            baseLayers['Satellite'].addTo(map);
                            break;
                        case 'topo':
                            baseLayers['Topography'].addTo(map);
                            break;
                    }
                });
            });
            
            // Timber areas toggle
            document.getElementById('timberAreas').addEventListener('change', function() {
                if (this.checked) {
                    if (saleAreasLayer) {
                        saleAreasLayer.addTo(map);
                    }
                } else {
                    if (saleAreasLayer && map.hasLayer(saleAreasLayer)) {
                        map.removeLayer(saleAreasLayer);
                    }
                }
            });
        }
        
        async function loadDataFromFile() {
            showLoading(true, 'Loading timber sale data...');
            
            try {
                const response = await fetch('./data/current.geojson', {
                    cache: 'no-cache',
                    headers: {
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                timberSaleData = await response.json();
                
                // Validate the data
                if (!timberSaleData || !timberSaleData.features) {
                    throw new Error('Invalid GeoJSON format - missing features array');
                }
                
                loadTimberSaleData();
                lastUpdateTime = new Date();
                document.getElementById('updateTime').textContent = lastUpdateTime.toLocaleString();
                showNotification(`Successfully loaded ${timberSaleData.features.length} timber sale areas!`, 'success');
                
            } catch (error) {
                console.error('Failed to load data from file:', error);
                showNotification(`Failed to load data: ${error.message}. Please ensure the data/current.geojson file exists.`, 'warning');
                loadFallbackData(); // Load basic sample data if file loading fails
            }
            
            showLoading(false);
        }
        
        function loadFallbackData() {
            // Fallback sample data in case the external file fails to load
            timberSaleData = {
                "type": "FeatureCollection",
                "features": [
                    {
                        "type": "Feature",
                        "properties": {
                            "id": "SAMPLE-ACTIVE",
                            "name": "Sample Active Sale",
                            "acres": 50,
                            "volume": "Sample Volume",
                            "species": "Mixed Hardwood",
                            "location": "Wisconsin",
                            "status": "active",
                            "bid_due": "October 15, 2025 @ 12PM",
                            "prospectus_url": "#"
                        },
                        "geometry": {
                            "type": "Polygon",
                            "coordinates": [[
                                [-90.0, 44.0],
                                [-89.9, 44.0],
                                [-89.9, 43.9],
                                [-90.0, 43.9],
                                [-90.0, 44.0]
                            ]]
                        }
                    },
                    {
                        "type": "Feature",
                        "properties": {
                            "id": "SAMPLE-CLOSED",
                            "name": "Sample Closed Sale",
                            "acres": 30,
                            "volume": "Sample Volume",
                            "species": "Mixed Hardwood",
                            "location": "Wisconsin",
                            "status": "Sale Closed",
                            "bid_due": "September 10, 2025 @ 12PM",
                            "prospectus_url": "#"
                        },
                        "geometry": {
                            "type": "Polygon",
                            "coordinates": [[
                                [-90.2, 44.0],
                                [-90.1, 44.0],
                                [-90.1, 43.9],
                                [-90.2, 43.9],
                                [-90.2, 44.0]
                            ]]
                        }
                    }
                ]
            };
            
            loadTimberSaleData();
            lastUpdateTime = new Date();
            document.getElementById('updateTime').textContent = lastUpdateTime.toLocaleString();
        }
        
        function loadTimberSaleData() {
            if (!timberSaleData || !timberSaleData.features) {
                console.error('No data available to load');
                return;
            }
            
            currentData = timberSaleData.features;
            updateDisplayedData();
        }
        
        function updateStatistics(features) {
            const totalAreas = features.length;
            const totalAcres = features.reduce((sum, feature) => {
                const acres = parseFloat(feature.properties.acres || 0);
                return sum + acres;
            }, 0);
